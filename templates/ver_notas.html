<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Notas</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <style>
        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }

        .grade-badge {
            font-size: 0.9em;
            width: 100px;
        }

        .chart-container {
            position: relative;
            height: 200px;
            width: 200px;
            margin: 0 auto;
        }

        .stat-card {
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }
    </style>
</head>

<body class="bg-light">
    <!-- Navbar Simples -->
    <nav class="navbar navbar-dark bg-dark mb-4 shadow">
        <div class="container">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-bar-chart-line-fill me-2"></i> Relatório de Desempenho
            </span>
            <a href="/dashboard" class="btn btn-outline-light btn-sm">
                <i class="bi bi-arrow-left me-1"></i> Voltar ao Painel
            </a>
        </div>
    </nav>

    <div class="container pb-5">

        <!-- Cabeçalho e Ações -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold text-primary mb-0">{{ prova.titulo }}</h2>
                <p class="text-muted">Análise de desempenho da turma</p>
            </div>
            <a href="/exportar_excel/{{ prova.id }}" class="btn btn-success shadow-sm">
                <i class="bi bi-file-earmark-excel-fill me-2"></i>Baixar Excel
            </a>
        </div>

        <!-- PAINEL DE ESTATÍSTICAS (NOVO!) -->
        <div class="row g-4 mb-4">
            <!-- Card 1: Gráfico de Pizza (Aprovação) -->
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100 stat-card">
                    <div class="card-body text-center">
                        <h6 class="text-muted text-uppercase mb-3 fw-bold">Taxa de Aprovação</h6>
                        {% if stats.total > 0 %}
                        <div class="chart-container">
                            <canvas id="chartAprovacao"></canvas>
                        </div>
                        {% else %}
                        <div class="py-5 text-muted">
                            <i class="bi bi-pie-chart fs-1 d-block mb-2"></i>
                            Sem dados suficientes
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Card 2: Estatísticas Numéricas -->
            <div class="col-md-8">
                <div class="row g-3 h-100">
                    <!-- Média da Turma -->
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm h-100 bg-primary text-white stat-card">
                            <div class="card-body text-center d-flex flex-column justify-content-center">
                                <h1 class="display-3 fw-bold mb-0">{{ stats.media }}</h1>
                                <p class="mb-0 opacity-75 fw-bold">Média da Turma</p>
                            </div>
                        </div>
                    </div>
                    <!-- Total de Entregas -->
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm h-100 stat-card">
                            <div class="card-body text-center d-flex flex-column justify-content-center">
                                <h2 class="text-dark fw-bold mb-0 display-4">{{ stats.total }}</h2>
                                <p class="text-muted mb-0 fw-bold">Provas Entregues</p>
                            </div>
                        </div>
                    </div>
                    <!-- Detalhe Aprovados/Reprovados -->
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm h-100 stat-card">
                            <div class="card-body d-flex flex-column justify-content-center gap-3">
                                <div class="d-flex justify-content-between align-items-center border-bottom pb-2">
                                    <span class="text-success fw-bold"><i
                                            class="bi bi-check-circle-fill me-2"></i>Aprovados</span>
                                    <span class="badge bg-success rounded-pill fs-6">{{ stats.aprovados }}</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-danger fw-bold"><i
                                            class="bi bi-x-circle-fill me-2"></i>Reprovados</span>
                                    <span class="badge bg-danger rounded-pill fs-6">{{ stats.reprovados }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela de Alunos -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3 border-bottom-0">
                <h6 class="mb-0 fw-bold text-secondary"><i class="bi bi-person-lines-fill me-2"></i>Lista de Alunos</h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4 py-3">Aluno</th>
                                <th>Email</th>
                                <th>Data Envio</th>
                                <th class="text-center">Nota</th>
                                <th class="text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for res in resultados %}
                            <tr>
                                <td class="ps-4 fw-bold text-dark">{{ res.aluno.nome }}</td>
                                <td class="text-muted">{{ res.aluno.email }}</td>
                                <td>
                                    <span class="badge bg-light text-dark border">
                                        <i class="bi bi-calendar3 me-1"></i> {{ res.data_envio.strftime('%d/%m %H:%M')
                                        }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span
                                        class="fs-5 fw-bold {% if res.nota >= 7 %}text-success{% else %}text-danger{% endif %}">
                                        {{ "%.1f"|format(res.nota) }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    {% if res.nota >= 7.0 %}
                                    <span
                                        class="badge bg-success bg-opacity-10 text-success border border-success rounded-pill grade-badge">Aprovado</span>
                                    {% else %}
                                    <span
                                        class="badge bg-danger bg-opacity-10 text-danger border border-danger rounded-pill grade-badge">Reprovado</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center py-5 text-muted">
                                    <i class="bi bi-inbox fs-1 d-block mb-2 opacity-50"></i>
                                    Nenhum aluno realizou esta prova ainda.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white text-muted small py-3 border-top-0">
                Total de envios: <strong>{{ resultados|length }}</strong>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Importação do Chart.js para os gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Configuração do Gráfico de Rosca (Doughnut Chart)
        const ctx = document.getElementById('chartAprovacao');
        if (ctx) {
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Aprovados', 'Reprovados'],
                    datasets: [{
                        // Correção: Envolver as variáveis do template em aspas e converter para número
                        // Isto previne o erro de sintaxe no JavaScript quando o ficheiro não é renderizado pelo servidor
                        data: [Number('{{ stats.aprovados }}'), Number('{{ stats.reprovados }}')],
                        backgroundColor: ['#198754', '#dc3545'], // Verde e Vermelho
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.label || '';
                                    let value = context.parsed;
                                    let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    let percentage = 0;
                                    if (total > 0) {
                                        percentage = Math.round((value / total) * 100);
                                    }
                                    return label + ': ' + value + ' (' + percentage + '%)';
                                }
                            }
                        }
                    },
                    cutout: '70%', // Faz o buraco da rosca
                }
            });
        }
    </script>
</body>

</html>